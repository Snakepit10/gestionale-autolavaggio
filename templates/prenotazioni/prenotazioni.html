{% extends 'base.html' %}
{% load static %}

{% block title %}Prenotazioni Online - Gestionale Autolavaggio{% endblock %}

{% block extra_css %}
<style>
.hero-section {
    background: linear-gradient(135deg, #0d6efd, #6610f2);
    color: white;
    border-radius: 15px;
    padding: 40px;
    margin-bottom: 30px;
    text-align: center;
}

.service-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    height: 100%;
}

.service-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.service-card.selected {
    border: 2px solid #0d6efd;
    transform: translateY(-3px);
}

.service-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #0d6efd, #6610f2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    color: white;
    font-size: 1.5rem;
}

.booking-steps {
    display: flex;
    justify-content: space-between;
    margin: 30px 0;
    position: relative;
}

.booking-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 40px;
    right: 40px;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    position: relative;
    z-index: 2;
}

.step.active {
    background: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.step.completed {
    background: #28a745;
    border-color: #28a745;
    color: white;
}

.reservation-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #0d6efd;
}

.reservation-card.pending {
    border-left-color: #ffc107;
}

.reservation-card.confirmed {
    border-left-color: #28a745;
}

.reservation-card.cancelled {
    border-left-color: #dc3545;
    opacity: 0.7;
}

.time-slot {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.time-slot:hover {
    border-color: #0d6efd;
    background: #f8f9ff;
}

.time-slot.selected {
    border-color: #0d6efd;
    background: #0d6efd;
    color: white;
}

.time-slot.unavailable {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f8f9fa;
}

.calendar-widget {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    padding: 20px;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.action-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    text-decoration: none;
    color: inherit;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.action-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    color: inherit;
    text-decoration: none;
}

.action-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #0d6efd, #6610f2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    color: white;
    font-size: 1.2rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.booking-form-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    padding: 30px;
}

.next-available {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="hero-section">
        <h1 class="display-4 mb-3">
            <i class="bi bi-calendar-check"></i>
            Prenota il Tuo Servizio
        </h1>
        <p class="lead">Scegli data, ora e servizio. È veloce e semplice!</p>
        <div class="mt-4">
            <a href="#booking-form" class="btn btn-light btn-lg me-3">
                <i class="bi bi-plus-circle"></i> Nuova Prenotazione
            </a>
            <a href="{% url 'prenotazioni:calendario-prenotazioni' %}" class="btn btn-outline-light btn-lg">
                <i class="bi bi-calendar"></i> Vedi Calendario
            </a>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- Colonna principale -->
        <div class="col-lg-8">
            <!-- Azioni Rapide -->
            <div class="quick-actions">
                <a href="{% url 'prenotazioni:nuova-prenotazione' %}" class="action-card">
                    <div class="action-icon">
                        <i class="bi bi-plus-circle"></i>
                    </div>
                    <h5>Nuova Prenotazione</h5>
                    <p class="text-muted mb-0">Prenota subito il tuo servizio</p>
                </a>
                <a href="{% url 'prenotazioni:calendario-prenotazioni' %}" class="action-card">
                    <div class="action-icon">
                        <i class="bi bi-calendar"></i>
                    </div>
                    <h5>Calendario</h5>
                    <p class="text-muted mb-0">Vedi disponibilità</p>
                </a>
                <a href="#mie-prenotazioni" class="action-card">
                    <div class="action-icon">
                        <i class="bi bi-list-check"></i>
                    </div>
                    <h5>Le Mie Prenotazioni</h5>
                    <p class="text-muted mb-0">Gestisci prenotazioni</p>
                </a>
                {% comment %}
                <a href="{% url 'clienti:area-cliente' %}" class="action-card">
                    <div class="action-icon">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <h5>Area Cliente</h5>
                    <p class="text-muted mb-0">Il tuo profilo</p>
                </a>
                {% endcomment %}
            </div>

            <!-- Form Prenotazione Rapida -->
            <div class="booking-form-container" id="booking-form">
                <h3 class="mb-4">
                    <i class="bi bi-lightning-charge text-primary"></i>
                    Prenotazione Rapida
                </h3>
                
                <!-- Steps -->
                <div class="booking-steps">
                    <div class="step active" id="step-1">1</div>
                    <div class="step" id="step-2">2</div>
                    <div class="step" id="step-3">3</div>
                    <div class="step" id="step-4">4</div>
                </div>
                
                <div class="step-labels d-flex justify-content-between mb-4">
                    <small class="text-muted">Scegli Servizio</small>
                    <small class="text-muted">Seleziona Data</small>
                    <small class="text-muted">Scegli Orario</small>
                    <small class="text-muted">Conferma</small>
                </div>

                <form id="quick-booking-form">
                    {% csrf_token %}
                    <!-- Step 1: Servizi -->
                    <div class="step-content" id="step-content-1">
                        <h5 class="mb-3">Scegli il Servizio</h5>
                        <div class="row">
                            {% for servizio in servizi %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="service-card card" onclick="selectService('{{ servizio.id }}', '{{ servizio.titolo }}', '{{ servizio.prezzo }}')">
                                    <div class="card-body text-center">
                                        <div class="service-icon">
                                            <i class="bi bi-droplet"></i>
                                        </div>
                                        <h6 class="card-title">{{ servizio.titolo }}</h6>
                                        <p class="text-primary h5 mb-2">€{{ servizio.prezzo }}</p>
                                        <small class="text-muted">{{ servizio.durata_minuti }} min</small>
                                        {% if servizio.descrizione %}
                                            <p class="small text-muted mt-2">{{ servizio.descrizione|truncatewords:8 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Step 2: Data -->
                    <div class="step-content" id="step-content-2" style="display: none;">
                        <h5 class="mb-3">Seleziona la Data</h5>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="next-available">
                                    <h6><i class="bi bi-clock"></i> Prossimo Slot Disponibile</h6>
                                    <p class="mb-0" id="next-available-info">Caricamento...</p>
                                </div>
                                <input type="date" class="form-control form-control-lg" id="selected-date" 
                                       min="{{ today|date:'Y-m-d' }}" onchange="loadAvailableSlots()">
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <h6 class="text-muted">Calendario</h6>
                                    <a href="{% url 'prenotazioni:calendario-prenotazioni' %}" class="btn btn-outline-primary">
                                        <i class="bi bi-calendar"></i> Apri Calendario
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Orario -->
                    <div class="step-content" id="step-content-3" style="display: none;">
                        <h5 class="mb-3">Scegli l'Orario</h5>
                        <div id="available-slots">
                            <div class="text-center py-4">
                                <i class="bi bi-clock display-6 text-muted"></i>
                                <p class="text-muted">Seleziona prima una data per vedere gli orari disponibili</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Conferma -->
                    <div class="step-content" id="step-content-4" style="display: none;">
                        <h5 class="mb-3">Conferma Prenotazione</h5>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Riepilogo Prenotazione</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Servizio:</strong> <span id="summary-service">-</span></li>
                                            <li><strong>Data:</strong> <span id="summary-date">-</span></li>
                                            <li><strong>Orario:</strong> <span id="summary-time">-</span></li>
                                            <li><strong>Prezzo:</strong> <span id="summary-price" class="text-primary">€0.00</span></li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Dati Cliente</h6>
                                        {% if user.is_authenticated %}
                                            <p class="mb-1"><strong>{{ user.get_full_name|default:user.username }}</strong></p>
                                            <p class="mb-1">{{ user.email }}</p>
                                            {% if user.cliente.telefono %}
                                                <p class="mb-1">{{ user.cliente.telefono }}</p>
                                            {% endif %}
                                        {% else %}
                                            <div class="mb-3">
                                                <input type="text" class="form-control mb-2" placeholder="Nome e Cognome" id="guest-name">
                                                <input type="email" class="form-control mb-2" placeholder="Email" id="guest-email">
                                                <input type="tel" class="form-control" placeholder="Telefono" id="guest-phone">
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="privacy-consent" required>
                                    <label class="form-check-label" for="privacy-consent">
                                        Accetto i <a href="#" target="_blank">termini di servizio</a> e 
                                        l'<a href="#" target="_blank">informativa privacy</a>
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="marketing-consent">
                                    <label class="form-check-label" for="marketing-consent">
                                        Desidero ricevere comunicazioni promozionali
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigazione -->
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-secondary" id="prev-btn" 
                                onclick="previousStep()" style="display: none;">
                            <i class="bi bi-arrow-left"></i> Indietro
                        </button>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-primary" id="next-btn" 
                                    onclick="nextStep()" disabled>
                                Avanti <i class="bi bi-arrow-right"></i>
                            </button>
                            <button type="button" class="btn btn-success" id="confirm-btn" 
                                    onclick="confirmBooking()" style="display: none;">
                                <i class="bi bi-check-circle"></i> Conferma Prenotazione
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Le Mie Prenotazioni / Prenotazioni Recenti -->
            {% if user.is_authenticated and prenotazioni_future %}
            <div class="card mb-4" id="mie-prenotazioni">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check"></i>
                        {% if is_operator %}
                            Prenotazioni Recenti
                        {% else %}
                            Le Mie Prenotazioni
                        {% endif %}
                    </h5>
                    {% if is_operator %}
                    <div class="mt-2">
                        <a href="{% url 'prenotazioni:prenotazioni-admin' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-list"></i> Vedi Tutte
                        </a>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% for prenotazione in prenotazioni_future %}
                    <div class="reservation-card {{ prenotazione.stato }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ prenotazione.slot.data|date:"d/m/Y" }}</h6>
                                <p class="mb-1 text-muted">{{ prenotazione.slot.ora_inizio }} - {{ prenotazione.slot.ora_fine }}</p>
                                <small class="badge bg-primary">{{ prenotazione.get_stato_display }}</small>
                            </div>
                            <div class="text-end">
                                <a href="{% url 'prenotazioni:dettaglio-prenotazione' prenotazione.pk %}" 
                                   class="btn btn-sm btn-outline-primary">Dettagli</a>
                            </div>
                        </div>
                        <div class="mt-2">
                            {% for servizio in prenotazione.servizi.all %}
                                <span class="badge bg-light text-dark me-1">{{ servizio.titolo }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    {% comment %}
                    <div class="text-center">
                        <a href="{% url 'clienti:area-cliente' %}" class="btn btn-outline-primary">
                            Vedi Tutte
                        </a>
                    </div>
                    {% endcomment %}
                </div>
            </div>
            {% endif %}

            <!-- Servizi Popolari -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-star"></i>
                        Servizi Più Richiesti
                    </h6>
                </div>
                <div class="card-body">
                    {% for servizio in servizi|slice:":3" %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">{{ servizio.titolo }}</h6>
                            <small class="text-muted">{{ servizio.durata_minuti }} minuti</small>
                        </div>
                        <div class="text-end">
                            <div class="text-primary fw-bold">€{{ servizio.prezzo }}</div>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="selectService('{{ servizio.id }}', '{{ servizio.titolo }}', '{{ servizio.prezzo }}')">
                                Scegli
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Calendario Widget -->
            <div class="calendar-widget">
                <h6 class="mb-3">
                    <i class="bi bi-calendar-week"></i>
                    Disponibilità Prossimi Giorni
                </h6>
                <div id="mini-calendar">
                    <!-- Caricato via JavaScript -->
                </div>
                <div class="text-center mt-3">
                    <a href="{% url 'prenotazioni:calendario-prenotazioni' %}" class="btn btn-outline-primary btn-sm">
                        Calendario Completo
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
let selectedService = null;
let selectedDate = null;
let selectedSlot = null;

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    loadMiniCalendar();
    loadNextAvailable();
    
    // Imposta data minima
    const today = new Date();
    document.getElementById('selected-date').min = today.toISOString().split('T')[0];
});

function selectService(id, name, price) {
    // Rimuovi selezioni precedenti
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Seleziona servizio
    event.currentTarget.classList.add('selected');
    selectedService = { id, name, price };
    
    // Abilita pulsante avanti
    document.getElementById('next-btn').disabled = false;
    
    // Aggiorna riepilogo
    document.getElementById('summary-service').textContent = name;
    document.getElementById('summary-price').textContent = `€${price}`;
}

function nextStep() {
    if (currentStep < 4) {
        // Nascondi step corrente
        document.getElementById(`step-content-${currentStep}`).style.display = 'none';
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.getElementById(`step-${currentStep}`).classList.add('completed');
        
        // Mostra prossimo step
        currentStep++;
        document.getElementById(`step-content-${currentStep}`).style.display = 'block';
        document.getElementById(`step-${currentStep}`).classList.add('active');
        
        updateNavigation();
        
        if (currentStep === 2) {
            // Focus sulla data
            document.getElementById('selected-date').focus();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        // Nascondi step corrente
        document.getElementById(`step-content-${currentStep}`).style.display = 'none';
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        
        // Mostra step precedente
        currentStep--;
        document.getElementById(`step-content-${currentStep}`).style.display = 'block';
        document.getElementById(`step-${currentStep}`).classList.remove('completed');
        document.getElementById(`step-${currentStep}`).classList.add('active');
        
        updateNavigation();
    }
}

function updateNavigation() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const confirmBtn = document.getElementById('confirm-btn');
    
    // Mostra/nascondi pulsante indietro
    prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
    
    if (currentStep === 4) {
        // Ultimo step - mostra conferma
        nextBtn.style.display = 'none';
        confirmBtn.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        confirmBtn.style.display = 'none';
        
        // Abilita/disabilita pulsante avanti in base al contenuto
        let canProceed = false;
        switch(currentStep) {
            case 1:
                canProceed = selectedService !== null;
                break;
            case 2:
                canProceed = selectedDate !== null;
                break;
            case 3:
                canProceed = selectedSlot !== null;
                break;
        }
        nextBtn.disabled = !canProceed;
    }
}

function loadAvailableSlots() {
    const dateInput = document.getElementById('selected-date');
    const date = dateInput.value;
    
    if (!date || !selectedService) return;
    
    selectedDate = date;
    document.getElementById('summary-date').textContent = new Date(date).toLocaleDateString('it-IT');
    document.getElementById('next-btn').disabled = false;
    
    // Carica slot via API
    fetch(`/prenotazioni/api/slot-disponibili/?data=${date}&servizio=${selectedService.id}`)
        .then(response => response.json())
        .then(data => {
            displayAvailableSlots(data.slot);
        })
        .catch(error => {
            console.error('Errore nel caricamento slot:', error);
        });
}

function displayAvailableSlots(slots) {
    const container = document.getElementById('available-slots');
    
    if (slots.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-calendar-x display-6 text-muted"></i>
                <h6 class="text-muted mt-2">Nessun orario disponibile</h6>
                <p class="text-muted">Prova con un'altra data</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    slots.forEach(slot => {
        const isAvailable = slot.posti_disponibili > 0;
        html += `
            <div class="col-md-6 col-lg-4 mb-2">
                <div class="time-slot ${isAvailable ? '' : 'unavailable'}" 
                     onclick="${isAvailable ? `selectTimeSlot('${slot.id}', '${slot.ora_inizio}', '${slot.ora_fine}')` : ''}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${slot.ora_inizio} - ${slot.ora_fine}</strong>
                        </div>
                        <div>
                            <small class="badge ${isAvailable ? 'bg-success' : 'bg-secondary'}">
                                ${isAvailable ? `${slot.posti_disponibili} disponibili` : 'Completo'}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function selectTimeSlot(id, start, end) {
    // Rimuovi selezioni precedenti
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
    });
    
    // Seleziona slot
    event.currentTarget.classList.add('selected');
    selectedSlot = { id, start, end };
    
    // Aggiorna riepilogo
    document.getElementById('summary-time').textContent = `${start} - ${end}`;
    
    // Abilita pulsante avanti
    document.getElementById('next-btn').disabled = false;
}

function confirmBooking() {
    if (!selectedService || !selectedDate || !selectedSlot) {
        alert('Completa tutti i passaggi prima di confermare');
        return;
    }
    
    const consent = document.getElementById('privacy-consent').checked;
    if (!consent) {
        alert('Devi accettare i termini di servizio per continuare');
        return;
    }
    
    // Prepara i dati per l'API
    const formData = new FormData();
    
    // CSRF token
    const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfTokenElement) {
        alert('Errore: token CSRF non trovato. Ricarica la pagina.');
        return;
    }
    formData.append('csrfmiddlewaretoken', csrfTokenElement.value);
    
    // Dati prenotazione
    formData.append('servizi_selezionati', selectedService.id);
    formData.append('data_prenotazione', selectedDate);
    formData.append('ora_prenotazione', selectedSlot.start);
    
    // Dati ospite se non autenticato
    if (!document.querySelector('body').classList.contains('authenticated')) {
        const guestNameElement = document.getElementById('guest-name');
        const guestEmailElement = document.getElementById('guest-email');
        const guestPhoneElement = document.getElementById('guest-phone');
        
        const guestName = guestNameElement ? guestNameElement.value : '';
        const guestEmail = guestEmailElement ? guestEmailElement.value : '';
        const guestPhone = guestPhoneElement ? guestPhoneElement.value : '';
        
        if (guestName) formData.append('nome_cliente', guestName);
        if (guestEmail) formData.append('email_cliente', guestEmail);
        if (guestPhone) formData.append('telefono_cliente', guestPhone);
    }
    
    // Invia alla nuova API
    fetch('{% url "prenotazioni:prenotazione-rapida" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfTokenElement.value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostra messaggio di successo
            alert(`Prenotazione confermata! Codice: ${data.codice}`);
            // Reindirizza alla pagina di dettaglio
            window.location.href = data.redirect_url;
        } else {
            alert('Errore nella prenotazione: ' + data.error);
        }
    })
    .catch(error => {
        alert('Errore di connessione. Riprova.');
        console.error('Error:', error);
    });
}

function loadMiniCalendar() {
    // Mini calendario semplificato senza chiamata API
    const container = document.getElementById('mini-calendar');
    if (!container) return;
    
    const today = new Date();
    let html = '';
    
    // Genera i prossimi 7 giorni
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dayName = date.toLocaleDateString('it-IT', { weekday: 'short' });
        const dayNum = date.getDate();
        
        // Simula disponibilità (tutti i giorni disponibili per ora)
        const disponibile = true;
        
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded ${disponibile ? 'bg-success' : 'bg-light'} text-${disponibile ? 'white' : 'muted'}">
                <div>
                    <strong>${dayName} ${dayNum}</strong>
                </div>
                <div>
                    <small>Disponibile</small>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function loadNextAvailable() {
    // Informazioni semplificate senza chiamata API
    const info = document.getElementById('next-available-info');
    if (!info) return;
    
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toLocaleDateString('it-IT');
    
    info.innerHTML = `<strong>${tomorrowStr} alle 09:00</strong> - Slot disponibili`;
}

// Auto-aggiornamento ogni 30 secondi (solo per slot disponibili)
setInterval(() => {
    if (currentStep === 3 && selectedDate) {
        loadAvailableSlots();
    }
}, 30000);
</script>
{% endblock %}