{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}
        Modifica Prenotazione - Gestionale Autolavaggio
    {% else %}
        Nuova Prenotazione - Gestionale Autolavaggio
    {% endif %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-calendar-plus"></i>
        {% if form.instance.pk %}
            Modifica Prenotazione
        {% else %}
            Nuova Prenotazione
        {% endif %}
    </h1>
    <div>
        {% if form.instance.pk %}
            <a href="{% url 'prenotazioni:dettaglio-prenotazione' form.instance.pk %}" class="btn btn-outline-info me-2">
                <i class="bi bi-eye"></i> Visualizza
            </a>
        {% endif %}
        <a href="{% url 'prenotazioni:prenotazioni' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Torna alla Lista
        </a>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-form-select"></i>
                    Dati Prenotazione
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="prenotazioneForm">
                    {% csrf_token %}
                    
                    <!-- Informazioni Cliente -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-person"></i> Informazioni Cliente
                            </h6>
                        </div>
                        <div class="col-md-6">
                            {{ form.cliente|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.nome_cliente|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.email_cliente|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.telefono_cliente|as_crispy_field }}
                        </div>
                    </div>

                    <!-- Dettagli Prenotazione -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-calendar-event"></i> Dettagli Prenotazione
                            </h6>
                        </div>
                        <div class="col-md-4">
                            {{ form.data_prenotazione|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {{ form.ora_prenotazione|as_crispy_field }}
                        </div>
                    </div>

                    <!-- Servizi -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-gear"></i> Servizi Richiesti
                            </h6>
                            {{ form.servizi_selezionati|as_crispy_field }}
                        </div>
                    </div>


                    <!-- Note e Stato -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-chat-text"></i> Note e Stato
                            </h6>
                        </div>
                        <div class="col-md-8">
                            {{ form.note_cliente|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {% if form.instance.pk %}
                                {{ form.stato|as_crispy_field }}
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i>
                                    {% if form.instance.pk %}
                                        Aggiorna Prenotazione
                                    {% else %}
                                        Crea Prenotazione
                                    {% endif %}
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="calcolaTotale()">
                                    <i class="bi bi-calculator"></i> Calcola Totale
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Riepilogo Prenotazione -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-receipt"></i>
                    Riepilogo
                </h6>
            </div>
            <div class="card-body">
                <div id="riepilogo-content">
                    {% if form.instance.pk %}
                        <div class="mb-2">
                            <strong>Codice:</strong> {{ form.instance.codice_prenotazione }}
                        </div>
                        <div class="mb-2">
                            <strong>Data:</strong> {{ form.instance.data_prenotazione|date:"d/m/Y" }}
                        </div>
                        <div class="mb-2">
                            <strong>Ora:</strong> {{ form.instance.ora_prenotazione|time:"H:i" }}
                        </div>
                        <div class="mb-2">
                            <strong>Stato:</strong>
                            {% if form.instance.stato == 'confermata' %}
                                <span class="badge bg-success">Confermata</span>
                            {% elif form.instance.stato == 'in_attesa' %}
                                <span class="badge bg-warning">In Attesa</span>
                            {% elif form.instance.stato == 'completata' %}
                                <span class="badge bg-primary">Completata</span>
                            {% elif form.instance.stato == 'cancellata' %}
                                <span class="badge bg-danger">Cancellata</span>
                            {% endif %}
                        </div>
                        <hr>
                        <div class="mb-2">
                            <strong>Totale Stimato:</strong>
                            <span class="h5 text-primary">€{{ form.instance.totale_stimato|floatformat:2 }}</span>
                        </div>
                    {% else %}
                        <p class="text-muted">Il riepilogo apparirà dopo aver selezionato i servizi.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Disponibilità Slot -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock"></i>
                    Disponibilità
                </h6>
            </div>
            <div class="card-body">
                <div id="disponibilita-content">
                    <p class="text-muted">Seleziona una data per vedere gli slot disponibili.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calcola totale stimato
function calcolaTotale() {
    const serviziSelezionati = Array.from(document.querySelectorAll('input[name="servizi_selezionati"]:checked'));
    
    if (serviziSelezionati.length === 0) {
        alert('Seleziona almeno un servizio per calcolare il totale.');
        return;
    }

    // Simulazione calcolo totale (da implementare con AJAX)
    let totale = 0;
    serviziSelezionati.forEach(servizio => {
        // Qui dovremmo fare una chiamata AJAX per ottenere il prezzo
        totale += parseFloat(servizio.dataset.prezzo || 0);
    });

    document.getElementById('riepilogo-content').innerHTML = `
        <div class="mb-2">
            <strong>Servizi Selezionati:</strong> ${serviziSelezionati.length}
        </div>
        <hr>
        <div class="mb-2">
            <strong>Totale Stimato:</strong>
            <span class="h5 text-primary">€${totale.toFixed(2)}</span>
        </div>
    `;
}

// Controlla disponibilità quando cambia la data
document.addEventListener('DOMContentLoaded', function() {
    const dataField = document.getElementById('id_data_prenotazione');
    const oraField = document.getElementById('id_ora_prenotazione');
    
    if (dataField) {
        dataField.addEventListener('change', function() {
            verificaDisponibilita();
        });
    }
    
    if (oraField) {
        oraField.addEventListener('change', function() {
            verificaDisponibilita();
        });
    }
});

function verificaDisponibilita() {
    const data = document.getElementById('id_data_prenotazione').value;
    const ora = document.getElementById('id_ora_prenotazione').value;
    
    if (!data) return;
    
    // Chiamata AJAX per verificare disponibilità
    fetch(`{% url 'prenotazioni:slot-disponibili' %}?data=${data}&ora=${ora}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('disponibilita-content');
            
            if (data.disponibile) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        Slot disponibile
                    </div>
                    <small class="text-muted">
                        Posti liberi: ${data.posti_liberi}/${data.max_posti}
                    </small>
                `;
            } else {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        Slot non disponibile
                    </div>
                    <small class="text-muted">
                        Scegli un altro orario
                    </small>
                `;
            }
        })
        .catch(error => {
            console.error('Errore nella verifica disponibilità:', error);
        });
}

// Aggiorna automaticamente i campi cliente quando viene selezionato
document.addEventListener('DOMContentLoaded', function() {
    const clienteField = document.getElementById('id_cliente');
    if (clienteField) {
        clienteField.addEventListener('change', function() {
            if (this.value) {
                // Qui dovremmo fare una chiamata AJAX per ottenere i dati del cliente
                // e popolare automaticamente nome, email, telefono
            }
        });
    }
});
</script>
{% endblock %}