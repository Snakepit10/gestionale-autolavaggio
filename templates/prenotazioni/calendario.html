{% extends 'base.html' %}
{% load static %}

{% block title %}Calendario Prenotazioni - Gestionale Autolavaggio{% endblock %}

{% block extra_css %}
<style>
.calendar-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.week-view-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.week-day-column {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    min-height: 500px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.week-day-column.today {
    border-color: #0d6efd;
    background: #f8f9ff;
}

.week-day-column.closed {
    background: #ffe6e6;
    border-color: #dc3545;
    opacity: 0.7;
}

.day-header-week {
    text-align: center;
    font-weight: bold;
    font-size: 1.1rem;
    padding: 10px 0;
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 15px;
    color: #495057;
}

.day-header-week.today {
    color: #0d6efd;
    background: linear-gradient(135deg, #e7f3ff, #f8f9ff);
    border-radius: 8px;
    border-bottom-color: #0d6efd;
}

.slot-card {
    background: white;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    border-left: 4px solid #28a745;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
}

.slot-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.slot-card.full {
    border-left-color: #dc3545;
    background: #ffeaea;
}

.slot-card.limited {
    border-left-color: #ffc107;
    background: #fffbf0;
}

.slot-time {
    font-weight: bold;
    font-size: 0.9rem;
    color: #495057;
    margin-bottom: 5px;
}

.slot-availability {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 8px;
}

.slot-booking {
    background: #e3f2fd;
    border-radius: 6px;
    padding: 6px 8px;
    margin-bottom: 4px;
    border-left: 3px solid #2196f3;
    font-size: 0.8rem;
}

.slot-booking:last-child {
    margin-bottom: 0;
}

.booking-customer {
    font-weight: 600;
    color: #1976d2;
    margin-bottom: 2px;
}

.booking-details {
    color: #666;
    font-size: 0.75rem;
}

.booking-car {
    color: #444;
    font-weight: 500;
}

.booking-services {
    color: #666;
    font-style: italic;
}

.slot-booking-link {
    display: block;
    color: inherit;
    transition: all 0.2s ease;
}

.slot-booking-link:hover {
    color: inherit;
    transform: scale(1.02);
}

.slot-booking-link .slot-booking {
    transition: all 0.2s ease;
    border-radius: 4px;
    padding: 4px;
}

.slot-booking-link:hover .slot-booking {
    background-color: rgba(13, 110, 253, 0.1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.empty-day {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 40px 10px;
}

.week-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.week-range {
    font-size: 1.3rem;
    font-weight: bold;
    color: #0d6efd;
}

.calendar-header {
    background: linear-gradient(135deg, #0d6efd, #6610f2);
    color: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    margin-bottom: 20px;
}

.day-header {
    text-align: center;
    font-weight: bold;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    color: #6c757d;
}

.calendar-day {
    aspect-ratio: 1;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 80px;
}

.calendar-day:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.calendar-day.today {
    border-color: #0d6efd;
    background: #f8f9ff;
}

.calendar-day.selected {
    background: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.calendar-day.unavailable {
    background: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
}

.calendar-day.closed {
    background: #ffe6e6;
    color: #dc3545;
    cursor: not-allowed;
}

.calendar-day.other-month {
    opacity: 0.3;
    pointer-events: none;
}

.day-number {
    font-weight: bold;
    font-size: 1.1em;
}

.availability-indicator {
    margin-top: auto;
}

.slots-available {
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 10px;
    text-align: center;
}

.slots-high {
    background: #d4edda;
    color: #155724;
}

.slots-medium {
    background: #fff3cd;
    color: #856404;
}

.slots-low {
    background: #f8d7da;
    color: #721c24;
}

.month-navigation {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 20px;
}

.nav-button {
    background: none;
    border: 2px solid #0d6efd;
    color: #0d6efd;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-button:hover {
    background: #0d6efd;
    color: white;
}

.month-year {
    font-size: 1.2em;
    font-weight: bold;
    color: #0d6efd;
    margin: 0 20px;
}

.day-detail-panel {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    padding: 20px;
    position: sticky;
    top: 20px;
}

.slot-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    border-left: 4px solid #0d6efd;
    transition: all 0.3s ease;
}

.slot-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.slot-item.full {
    border-left-color: #dc3545;
    opacity: 0.7;
}

.slot-item.low {
    border-left-color: #ffc107;
}

.legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.booking-summary {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.quick-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 8px 16px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9em;
}

.filter-btn.active {
    background: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.calendar-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
}

.availability-heatmap {
    display: grid;
    grid-template-columns: repeat(24, 1fr);
    gap: 2px;
    margin: 10px 0;
}

.hour-cell {
    height: 20px;
    border-radius: 2px;
    position: relative;
}

.hour-cell.available {
    background: #28a745;
}

.hour-cell.limited {
    background: #ffc107;
}

.hour-cell.full {
    background: #dc3545;
}

.hour-cell.closed {
    background: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="calendar-header">
        <h1 class="display-5 mb-2">
            <i class="bi bi-calendar-week"></i>
            Calendario Prenotazioni
        </h1>
        <p class="lead mb-0">Scegli la data e l'orario perfetti per te</p>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Filtri Rapidi -->
    <div class="quick-filters">
        <button class="filter-btn active" onclick="setFilter('all')">Tutti i Giorni</button>
        <button class="filter-btn" onclick="setFilter('available')">Solo Disponibili</button>
        <button class="filter-btn" onclick="setFilter('weekend')">Weekend</button>
        <button class="filter-btn" onclick="setFilter('weekday')">Giorni Feriali</button>
    </div>

    <!-- Vista Settimanale -->
    <div class="week-view-container">
        <!-- Navigazione Settimana -->
        <div class="week-navigation">
            <button class="nav-button" onclick="previousWeek()">
                <i class="bi bi-chevron-left"></i>
            </button>
            <div class="week-range" id="current-week-range">
                Caricamento...
            </div>
            <button class="nav-button" onclick="nextWeek()">
                <i class="bi bi-chevron-right"></i>
            </button>
            <div class="ms-auto">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="goToCurrentWeek()">
                    <i class="bi bi-calendar-week"></i> Questa Settimana
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="refreshWeek()">
                    <i class="bi bi-arrow-clockwise"></i> Aggiorna
                </button>
            </div>
        </div>

        <!-- Griglia Settimana -->
        <div class="calendar-loading" id="week-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
        </div>

        <div id="week-content" style="display: none;">
            <div class="calendar-grid" id="week-grid">
                <!-- Generato via JavaScript -->
            </div>
        </div>

        <!-- Legenda -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #28a745;"></div>
                <span>Slot disponibili</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffc107;"></div>
                <span>Pochi posti</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #dc3545;"></div>
                <span>Completo</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2196f3;"></div>
                <span>Prenotazione esistente</span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Pannello Azioni Rapide -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-lightning"></i>
                        Azioni Rapide
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2 d-md-flex">
                        <a href="{% url 'prenotazioni:nuova-prenotazione' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Nuova Prenotazione
                        </a>
                        <a href="{% url 'prenotazioni:prenotazioni' %}" class="btn btn-outline-primary">
                            <i class="bi bi-list"></i> Lista Prenotazioni
                        </a>
                        <button class="btn btn-outline-info" onclick="printWeek()">
                            <i class="bi bi-printer"></i> Stampa Settimana
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pannello Dettagli Giorno -->
        <div class="col-lg-4">
            <div class="day-detail-panel">
                <div id="no-day-selected">
                    <div class="text-center py-4">
                        <i class="bi bi-calendar display-6 text-muted"></i>
                        <h5 class="text-muted mt-2">Seleziona una Data</h5>
                        <p class="text-muted">Clicca su un giorno per vedere gli orari disponibili</p>
                    </div>
                </div>

                <div id="day-details" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0" id="selected-date-title">Data Selezionata</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>

                    <!-- Heatmap Oraria -->
                    <div class="mb-3">
                        <h6 class="mb-2">DisponibilitÃ  Oraria</h6>
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>08:00</span>
                            <span>14:00</span>
                            <span>20:00</span>
                        </div>
                        <div class="availability-heatmap" id="hourly-heatmap">
                            <!-- Generato via JavaScript -->
                        </div>
                        <div class="small text-muted mt-1">
                            <span class="me-3">ðŸŸ¢ Disponibile</span>
                            <span class="me-3">ðŸŸ¡ Limitato</span>
                            <span class="me-3">ðŸ”´ Completo</span>
                            <span>âš« Chiuso</span>
                        </div>
                    </div>

                    <!-- Lista Slot -->
                    <div class="mb-3">
                        <h6 class="mb-2">Slot Disponibili</h6>
                        <div id="available-slots-list">
                            <!-- Generato via JavaScript -->
                        </div>
                    </div>

                    <!-- Azioni -->
                    <div class="d-grid gap-2">
                        <a href="#" class="btn btn-primary" id="book-now-btn" style="display: none;">
                            <i class="bi bi-plus-circle"></i> Prenota Ora
                        </a>
                        <a href="{% url 'prenotazioni:prenotazioni' %}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left"></i> Torna alle Prenotazioni
                        </a>
                    </div>
                </div>

                <!-- Riepilogo Selezione -->
                <div class="booking-summary" id="booking-summary" style="display: none;">
                    <h6><i class="bi bi-bookmark"></i> Prenotazione in Corso</h6>
                    <div id="booking-summary-content">
                        <!-- Contenuto dinamico -->
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-success" onclick="proceedToBooking()">
                            <i class="bi bi-arrow-right"></i> Completa Prenotazione
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearBookingSummary()">
                            Cancella Selezione
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistiche Rapide -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up"></i>
                        Statistiche Veloci
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h5 class="text-primary mb-0" id="stats-available-today">-</h5>
                            <small class="text-muted">Slot oggi</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-success mb-0" id="stats-next-free">-</h5>
                            <small class="text-muted">Prossimo libero</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Prenotazione Rapida -->
<div class="modal fade" id="quickBookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-lightning-charge"></i>
                    Prenotazione Rapida
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="quick-booking-content">
                    <!-- Contenuto dinamico -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Chiudi
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmQuickBooking()">
                    <i class="bi bi-check-circle"></i> Conferma
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentWeekStart = new Date();
let selectedSlot = null;
let weekData = {};
let currentFilter = 'all';

// Calcola l'inizio della settimana (lunedÃ¬)
function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is sunday
    return new Date(d.setDate(diff));
}

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    currentWeekStart = getWeekStart(new Date());
    initializeWeekView();
    loadWeekData();
    loadStats();
});

function initializeWeekView() {
    updateWeekRange();
    generateWeekView();
}

function updateWeekRange() {
    const endWeek = new Date(currentWeekStart);
    endWeek.setDate(endWeek.getDate() + 6);
    
    const startStr = currentWeekStart.toLocaleDateString('it-IT', { 
        day: 'numeric', 
        month: 'short' 
    });
    const endStr = endWeek.toLocaleDateString('it-IT', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
    });
    
    document.getElementById('current-week-range').textContent = `${startStr} - ${endStr}`;
}

function generateWeekView() {
    const container = document.getElementById('week-grid');
    container.innerHTML = '';
    
    const giorni = ['LunedÃ¬', 'MartedÃ¬', 'MercoledÃ¬', 'GiovedÃ¬', 'VenerdÃ¬', 'Sabato', 'Domenica'];
    
    for (let i = 0; i < 7; i++) {
        const currentDay = new Date(currentWeekStart);
        currentDay.setDate(currentWeekStart.getDate() + i);
        
        const dayColumn = createDayColumn(currentDay, giorni[i]);
        container.appendChild(dayColumn);
    }
    
    // Applica filtro corrente
    applyFilter(currentFilter);
}

function createDayColumn(date, dayName) {
    const column = document.createElement('div');
    const today = new Date();
    const isToday = date.toDateString() === today.toDateString();
    const isPast = date < today.setHours(0, 0, 0, 0);
    
    column.className = `week-day-column ${isToday ? 'today' : ''}`;
    column.dataset.date = date.toISOString().split('T')[0];
    
    const header = document.createElement('div');
    header.className = `day-header-week ${isToday ? 'today' : ''}`;
    header.innerHTML = `
        <div>${dayName}</div>
        <div style="font-size: 0.9rem; font-weight: normal;">${date.getDate()}/${date.getMonth() + 1}</div>
    `;
    
    column.appendChild(header);
    
    // Container per gli slot
    const slotsContainer = document.createElement('div');
    slotsContainer.className = 'slots-container';
    slotsContainer.id = `slots-${date.toISOString().split('T')[0]}`;
    
    if (isPast) {
        slotsContainer.innerHTML = '<div class="empty-day">Giorno passato</div>';
    } else {
        slotsContainer.innerHTML = '<div class="empty-day">Caricamento...</div>';
    }
    
    column.appendChild(slotsContainer);
    
    return column;
}

function createDayElement(date, currentMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';
    
    const isCurrentMonth = date.getMonth() === currentMonth;
    const isToday = date.toDateString() === new Date().toDateString();
    const isPast = date < new Date().setHours(0, 0, 0, 0);
    
    if (!isCurrentMonth) {
        dayDiv.classList.add('other-month');
    }
    
    if (isToday) {
        dayDiv.classList.add('today');
    }
    
    if (isPast) {
        dayDiv.classList.add('unavailable');
    }
    
    const dateString = date.toISOString().split('T')[0];
    dayDiv.dataset.date = dateString;
    
    dayDiv.innerHTML = `
        <div class="day-number">${date.getDate()}</div>
        <div class="availability-indicator">
            <div class="slots-available slots-high" id="indicator-${dateString}">
                Caricamento...
            </div>
        </div>
    `;
    
    dayDiv.addEventListener('click', () => selectDate(date));
    
    return dayDiv;
}

function loadWeekData() {
    document.getElementById('week-loading').style.display = 'flex';
    document.getElementById('week-content').style.display = 'none';
    
    const dataParam = currentWeekStart.toISOString().split('T')[0];
    
    fetch(`/prenotazioni/api/calendario-settimana/?data=${dataParam}`)
        .then(response => response.json())
        .then(data => {
            weekData = data;
            updateWeekView();
            document.getElementById('week-loading').style.display = 'none';
            document.getElementById('week-content').style.display = 'block';
        })
        .catch(error => {
            console.error('Errore nel caricamento settimana:', error);
            document.getElementById('week-loading').style.display = 'none';
            document.getElementById('week-content').style.display = 'block';
        });
}

function updateWeekView() {
    if (!weekData.giorni) return;
    
    weekData.giorni.forEach(giorno => {
        const container = document.getElementById(`slots-${giorno.data}`);
        const dayColumn = container.closest('.week-day-column');
        
        if (!container) return;
        
        // Aggiorna stile della colonna
        if (giorno.chiuso) {
            dayColumn.classList.add('closed');
            container.innerHTML = '<div class="empty-day">ðŸš« Chiuso</div>';
            return;
        }
        
        // Genera slot per questo giorno
        if (giorno.slot.length === 0) {
            container.innerHTML = '<div class="empty-day">Nessun slot disponibile</div>';
            return;
        }
        
        container.innerHTML = '';
        giorno.slot.forEach(slot => {
            const slotCard = createSlotCard(slot, giorno.data);
            container.appendChild(slotCard);
        });
    });
}

function createSlotCard(slot, date) {
    const card = document.createElement('div');
    let cardClass = 'slot-card';
    
    if (slot.posti_disponibili === 0) {
        cardClass += ' full';
    } else if (slot.posti_disponibili <= 1) {
        cardClass += ' limited';
    }
    
    card.className = cardClass;
    card.dataset.slotId = slot.id;
    card.dataset.date = date;
    
    // Contenuto della card
    let cardContent = `
        <div class="slot-time">${slot.ora_inizio} - ${slot.ora_fine}</div>
        <div class="slot-availability">
            ${slot.posti_disponibili > 0 ? 
                `${slot.posti_disponibili} di ${slot.max_prenotazioni} posti liberi` :
                'Completo'
            }
        </div>
    `;
    
    // Aggiungi prenotazioni esistenti
    if (slot.prenotazioni && slot.prenotazioni.length > 0) {
        slot.prenotazioni.forEach(prenotazione => {
            cardContent += `
                <a href="/prenotazioni/${prenotazione.id}/" class="slot-booking-link text-decoration-none">
                    <div class="slot-booking">
                        <div class="booking-customer">${prenotazione.cliente_nome}</div>
                        <div class="booking-details">
                            ${prenotazione.tipo_auto ? `<div class="booking-car">ðŸš— ${prenotazione.tipo_auto}</div>` : ''}
                            <div class="booking-services">${prenotazione.servizi.join(', ')}</div>
                            ${prenotazione.nota ? `<div class="booking-note">ðŸ’¬ ${prenotazione.nota}</div>` : ''}
                        </div>
                    </div>
                </a>
            `;
        });
    }
    
    // Bottone per prenotare se disponibile
    if (slot.is_disponibile && slot.posti_disponibili > 0) {
        cardContent += `
            <button class="btn btn-sm btn-success mt-2 w-100" onclick="prenotaSlot('${slot.id}', '${date}', '${slot.ora_inizio}', '${slot.ora_fine}')">
                <i class="bi bi-plus-circle"></i> Prenota
            </button>
        `;
    }
    
    card.innerHTML = cardContent;
    
    return card;
}

function selectDate(date) {
    const dateString = date.toISOString().split('T')[0];
    const dayData = calendarData[dateString];
    
    // Rimuovi selezione precedente
    document.querySelectorAll('.calendar-day.selected').forEach(day => {
        day.classList.remove('selected');
    });
    
    // Seleziona nuovo giorno
    const dayElement = document.querySelector(`[data-date="${dateString}"]`);
    if (dayElement && !dayElement.classList.contains('unavailable') && !dayElement.classList.contains('closed')) {
        dayElement.classList.add('selected');
        selectedDate = date;
        showDayDetails(date, dayData);
    }
}

function showDayDetails(date, dayData) {
    document.getElementById('no-day-selected').style.display = 'none';
    document.getElementById('day-details').style.display = 'block';
    
    const title = document.getElementById('selected-date-title');
    title.textContent = date.toLocaleDateString('it-IT', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Genera heatmap oraria
    generateHourlyHeatmap(dayData);
    
    // Carica slot dettagliati
    loadDaySlots(date.toISOString().split('T')[0]);
}

function generateHourlyHeatmap(dayData) {
    const container = document.getElementById('hourly-heatmap');
    container.innerHTML = '';
    
    for (let hour = 8; hour < 20; hour++) {
        const cell = document.createElement('div');
        cell.className = 'hour-cell';
        
        // Simula disponibilitÃ  per ora (da sostituire con dati reali)
        const availability = Math.random();
        if (availability > 0.7) {
            cell.classList.add('available');
        } else if (availability > 0.3) {
            cell.classList.add('limited');
        } else {
            cell.classList.add('full');
        }
        
        cell.title = `${hour}:00 - ${hour+1}:00`;
        container.appendChild(cell);
    }
}

function loadDaySlots(dateString) {
    fetch(`/prenotazioni/api/slot-disponibili/?data=${dateString}`)
        .then(response => response.json())
        .then(data => {
            displaySlots(data.slot);
        })
        .catch(error => {
            console.error('Errore nel caricamento slot:', error);
        });
}

function displaySlots(slots) {
    const container = document.getElementById('available-slots-list');
    const bookBtn = document.getElementById('book-now-btn');
    
    if (slots.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="bi bi-calendar-x text-muted"></i>
                <p class="text-muted mb-0">Nessun slot disponibile</p>
            </div>
        `;
        bookBtn.style.display = 'none';
        return;
    }
    
    container.innerHTML = '';
    let hasAvailable = false;
    
    slots.forEach(slot => {
        const isAvailable = slot.posti_disponibili > 0;
        if (isAvailable) hasAvailable = true;
        
        const slotDiv = document.createElement('div');
        slotDiv.className = `slot-item ${isAvailable ? '' : 'full'}`;
        slotDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${slot.ora_inizio} - ${slot.ora_fine}</strong>
                    ${isAvailable ? 
                        `<small class="d-block text-muted">${slot.posti_disponibili} posti disponibili</small>` :
                        `<small class="d-block text-danger">Completo</small>`
                    }
                </div>
                <div>
                    ${isAvailable ? 
                        `<button class="btn btn-sm btn-primary" onclick="selectSlot('${slot.id}', '${slot.ora_inizio}', '${slot.ora_fine}')">
                            Seleziona
                        </button>` :
                        `<span class="badge bg-secondary">Completo</span>`
                    }
                </div>
            </div>
        `;
        
        container.appendChild(slotDiv);
    });
    
    bookBtn.style.display = hasAvailable ? 'block' : 'none';
    if (hasAvailable) {
        bookBtn.href = `{% url 'prenotazioni:nuova-prenotazione' %}?data=${selectedDate.toISOString().split('T')[0]}`;
    }
}

function selectSlot(slotId, startTime, endTime) {
    selectedSlot = { id: slotId, start: startTime, end: endTime };
    
    const summary = document.getElementById('booking-summary');
    const content = document.getElementById('booking-summary-content');
    
    content.innerHTML = `
        <div class="d-flex justify-content-between mb-2">
            <span>Data:</span>
            <strong>${selectedDate.toLocaleDateString('it-IT')}</strong>
        </div>
        <div class="d-flex justify-content-between">
            <span>Orario:</span>
            <strong>${startTime} - ${endTime}</strong>
        </div>
    `;
    
    summary.style.display = 'block';
}

function proceedToBooking() {
    if (!selectedDate || !selectedSlot) {
        alert('Seleziona data e orario');
        return;
    }
    
    const params = new URLSearchParams({
        data: selectedDate.toISOString().split('T')[0],
        slot: selectedSlot.id
    });
    
    window.location.href = `{% url 'prenotazioni:nuova-prenotazione' %}?${params.toString()}`;
}

function clearSelection() {
    document.querySelectorAll('.calendar-day.selected').forEach(day => {
        day.classList.remove('selected');
    });
    
    document.getElementById('day-details').style.display = 'none';
    document.getElementById('no-day-selected').style.display = 'block';
    
    selectedDate = null;
    clearBookingSummary();
}

function clearBookingSummary() {
    document.getElementById('booking-summary').style.display = 'none';
    selectedSlot = null;
}

// Funzioni di navigazione settimana
function previousWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    updateWeekRange();
    generateWeekView();
    loadWeekData();
}

function nextWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    updateWeekRange();
    generateWeekView();
    loadWeekData();
}

function goToCurrentWeek() {
    currentWeekStart = getWeekStart(new Date());
    updateWeekRange();
    generateWeekView();
    loadWeekData();
}

function refreshWeek() {
    generateWeekView();
    loadWeekData();
}

// Funzione per prenotare uno slot
function prenotaSlot(slotId, date, oraInizio, oraFine) {
    const params = new URLSearchParams({
        data: date,
        slot: slotId,
        ora: oraInizio
    });
    
    window.location.href = `{% url 'prenotazioni:nuova-prenotazione' %}?${params.toString()}`;
}

// Funzione per stampare la settimana
function printWeek() {
    window.print();
}

function setFilter(filter) {
    // Aggiorna pulsanti
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    currentFilter = filter;
    applyFilter(filter);
}

function applyFilter(filter) {
    const columns = document.querySelectorAll('.week-day-column');
    
    columns.forEach(column => {
        const date = new Date(column.dataset.date);
        const dayOfWeek = date.getDay();
        let show = true;
        
        switch (filter) {
            case 'available':
                // Mostra solo giorni con slot disponibili
                const slotsContainer = column.querySelector('.slots-container');
                const hasAvailableSlots = slotsContainer && 
                    slotsContainer.querySelectorAll('.slot-card:not(.full)').length > 0;
                show = hasAvailableSlots && !column.classList.contains('closed');
                break;
            case 'weekend':
                show = dayOfWeek === 0 || dayOfWeek === 6; // Domenica o Sabato
                break;
            case 'weekday':
                show = dayOfWeek >= 1 && dayOfWeek <= 5; // LunedÃ¬-VenerdÃ¬
                break;
            default:
                show = true;
        }
        
        column.style.opacity = show ? '1' : '0.3';
        column.style.pointerEvents = show ? 'auto' : 'none';
    });
}

function loadStats() {
    fetch('/prenotazioni/api/statistiche-calendario/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('stats-available-today').textContent = data.slot_oggi || '0';
            document.getElementById('stats-next-free').textContent = data.prossimo_libero || 'N/A';
        });
}

// Auto-refresh ogni 2 minuti
setInterval(() => {
    if (!document.hidden) {
        loadWeekData();
        loadStats();
    }
}, 120000);
</script>
{% endblock %}