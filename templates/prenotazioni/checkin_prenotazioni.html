{% extends 'base.html' %}
{% load static %}

{% block title %}Check-in Prenotazioni - Gestionale Autolavaggio{% endblock %}

{% block extra_css %}
<style>
.checkin-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
}

.stats-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.prenotazione-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.prenotazione-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.prenotazione-urgente {
    border-left: 4px solid #dc3545;
}

.prenotazione-imminente {
    border-left: 4px solid #ffc107;
}

.prenotazione-normale {
    border-left: 4px solid #28a745;
}

.btn-checkin {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    color: white;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-checkin:hover {
    background: linear-gradient(135deg, #20c997, #28a745);
    transform: translateY(-1px);
    color: white;
}

.cliente-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.servizi-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.servizio-badge {
    background: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.filter-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
}

.prossimi-slot {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.slot-time {
    font-weight: bold;
    color: #856404;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="checkin-header text-center">
        <h1 class="h2 mb-3">
            <i class="bi bi-check-circle"></i>
            Check-in Prenotazioni
        </h1>
        <p class="lead mb-0">Gestisci l'arrivo dei clienti e converti le prenotazioni in ordini</p>
    </div>

    <!-- Statistiche -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="bi bi-calendar-check text-primary me-2" style="font-size: 2rem;"></i>
                        <h3 class="mb-0">{{ stats.totali_oggi }}</h3>
                    </div>
                    <p class="text-muted mb-0">Prenotazioni Oggi</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="bi bi-clock text-warning me-2" style="font-size: 2rem;"></i>
                        <h3 class="mb-0">{{ stats.da_fare_checkin }}</h3>
                    </div>
                    <p class="text-muted mb-0">Da Fare Check-in</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card text-center">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 2rem;"></i>
                        <h3 class="mb-0">{{ stats.checkin_completati }}</h3>
                    </div>
                    <p class="text-muted mb-0">Check-in Completati</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Prossimi Slot -->
    {% if prossimi_slot %}
    <div class="prossimi-slot">
        <h6><i class="bi bi-clock-history"></i> Prossimi Slot</h6>
        <div class="row">
            {% for slot in prossimi_slot %}
            <div class="col-md-2">
                <div class="text-center">
                    <div class="slot-time">{{ slot.slot.ora_inizio }}</div>
                    <small>{{ slot.cliente.nome|truncatewords:2 }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Filtri -->
        <div class="col-lg-3">
            <div class="filter-card">
                <h6 class="mb-3">
                    <i class="bi bi-funnel"></i> Filtri
                </h6>
                <form method="get" id="filterForm">
                    <div class="mb-3">
                        <label for="data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="data" name="data" 
                               value="{{ filtri.data }}" onchange="submitFilter()">
                    </div>
                    <div class="mb-3">
                        <label for="cliente" class="form-label">Cliente</label>
                        <input type="text" class="form-control" id="cliente" name="cliente" 
                               value="{{ filtri.cliente }}" placeholder="Nome o email..."
                               onchange="submitFilter()">
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Pulisci Filtri
                    </button>
                </form>
            </div>

            <!-- Link rapidi -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-link"></i> Link Rapidi
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'prenotazioni:prenotazioni-admin' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-list"></i> Tutte le Prenotazioni
                        </a>
                        <a href="{% url 'prenotazioni:nuova-prenotazione' %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-plus-circle"></i> Nuova Prenotazione
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista Prenotazioni -->
        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>
                    <i class="bi bi-list-check"></i> 
                    Prenotazioni da Fare Check-in ({{ prenotazioni.count }})
                </h5>
                <button class="btn btn-outline-primary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Aggiorna
                </button>
            </div>

            {% if prenotazioni %}
                {% for prenotazione in prenotazioni %}
                <div class="card prenotazione-card 
                    {% if prenotazione.slot.data == today and prenotazione.slot.ora_inizio <= now_time %}
                        prenotazione-urgente
                    {% elif prenotazione.slot.data == today %}
                        prenotazione-imminente
                    {% else %}
                        prenotazione-normale
                    {% endif %}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <!-- Info Principale -->
                            <div class="col-lg-6">
                                <div class="cliente-info">
                                    <h6 class="mb-2">
                                        <i class="bi bi-person-circle"></i>
                                        {% if prenotazione.cliente.ragione_sociale %}
                                            {{ prenotazione.cliente.ragione_sociale }}
                                        {% else %}
                                            {{ prenotazione.cliente.nome }}{% if prenotazione.cliente.cognome %} {{ prenotazione.cliente.cognome }}{% endif %}
                                        {% endif %}
                                    </h6>
                                    <div class="row text-sm">
                                        <div class="col-6">
                                            <small class="text-muted">
                                                <i class="bi bi-envelope"></i> 
                                                {{ prenotazione.cliente.email|default:"Non fornita" }}
                                            </small>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">
                                                <i class="bi bi-telephone"></i> 
                                                {{ prenotazione.cliente.telefono|default:"Non fornito" }}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data e Ora -->
                                <div class="mb-2">
                                    <strong>
                                        <i class="bi bi-calendar-event"></i>
                                        {{ prenotazione.slot.data|date:"d/m/Y" }} alle {{ prenotazione.slot.ora_inizio }}
                                    </strong>
                                    <span class="badge bg-secondary ms-2">{{ prenotazione.durata_stimata_minuti }} min</span>
                                </div>

                                <!-- Servizi -->
                                <div class="servizi-list">
                                    {% for servizio in prenotazione.servizi.all %}
                                        <span class="servizio-badge">{{ servizio.titolo }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Info Aggiuntive -->
                            <div class="col-lg-4">
                                <div class="text-center">
                                    <div class="mb-2">
                                        <strong>Codice: {{ prenotazione.codice_prenotazione }}</strong>
                                    </div>
                                    <div class="mb-2">
                                        <strong class="text-primary">
                                            €{{ prenotazione.totale_stimato|floatformat:2 }}
                                        </strong>
                                    </div>
                                    {% if prenotazione.nota_cliente %}
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <i class="bi bi-chat-text"></i>
                                                {{ prenotazione.nota_cliente|truncatewords:8 }}
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Azioni -->
                            <div class="col-lg-2">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-checkin" 
                                            onclick="showCheckinModal({{ prenotazione.pk }})">
                                        <i class="bi bi-check-circle-fill"></i>
                                        Check-in
                                    </button>
                                    <a href="{% url 'prenotazioni:dettaglio-prenotazione' prenotazione.pk %}" 
                                       class="btn btn-outline-info btn-sm mt-2">
                                        <i class="bi bi-eye"></i> Dettagli
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Paginazione -->
                {% if is_paginated %}
                <nav aria-label="Paginazione prenotazioni">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.data %}&data={{ request.GET.data }}{% endif %}{% if request.GET.cliente %}&cliente={{ request.GET.cliente }}{% endif %}">
                                    Precedente
                                </a>
                            </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">
                                Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.data %}&data={{ request.GET.data }}{% endif %}{% if request.GET.cliente %}&cliente={{ request.GET.cliente }}{% endif %}">
                                    Successiva
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">Nessuna prenotazione da fare check-in</h5>
                    <p class="text-muted">
                        {% if filtri.data or filtri.cliente %}
                            Modifica i filtri per vedere altre prenotazioni
                        {% else %}
                            Tutte le prenotazioni sono state processate!
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Conferma Check-in -->
<div class="modal fade" id="checkinModal" tabindex="-1" aria-labelledby="checkinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="checkinModalLabel">
                    <i class="bi bi-check-circle-fill"></i> Conferma Check-in
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Verifica e modifica i dati dell'ordine prima di procedere con il check-in
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-person-circle"></i> Informazioni Cliente</h6>
                        <div class="bg-light p-3 rounded mb-3">
                            <div class="mb-3">
                                <label for="modal-cliente-select" class="form-label">Cliente Esistente</label>
                                <select class="form-select" id="modal-cliente-select" onchange="handleClienteChange()">
                                    <option value="">Seleziona un cliente esistente...</option>
                                    {% for cliente in clienti %}
                                    <option value="{{ cliente.id }}" 
                                            data-nome="{{ cliente.nome }}" 
                                            data-cognome="{{ cliente.cognome|default:'' }}"
                                            data-ragione-sociale="{{ cliente.ragione_sociale|default:'' }}"
                                            data-email="{{ cliente.email|default:'' }}"
                                            data-telefono="{{ cliente.telefono|default:'' }}"
                                            data-tipo="{{ cliente.tipo_cliente }}">
                                        {% if cliente.ragione_sociale %}{{ cliente.ragione_sociale }}{% else %}{{ cliente.nome }} {{ cliente.cognome|default:'' }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Campi cliente -->
                            <div class="mb-3">
                                <label for="modal-tipo-cliente" class="form-label">Tipo Cliente</label>
                                <select class="form-select" id="modal-tipo-cliente" onchange="handleTipoClienteChange()">
                                    <option value="privato">Privato</option>
                                    <option value="business">Business</option>
                                </select>
                            </div>
                            
                            <!-- Campi per privato -->
                            <div id="modal-campi-privato">
                                <div class="mb-3">
                                    <label for="modal-cliente-nome-input" class="form-label">Nome *</label>
                                    <input type="text" class="form-control" id="modal-cliente-nome-input" required>
                                </div>
                                <div class="mb-3">
                                    <label for="modal-cliente-cognome-input" class="form-label">Cognome</label>
                                    <input type="text" class="form-control" id="modal-cliente-cognome-input">
                                </div>
                            </div>
                            
                            <!-- Campi per business -->
                            <div id="modal-campi-business" style="display: none;">
                                <div class="mb-3">
                                    <label for="modal-ragione-sociale-input" class="form-label">Ragione Sociale *</label>
                                    <input type="text" class="form-control" id="modal-ragione-sociale-input">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="modal-cliente-email-input" class="form-label">Email</label>
                                <input type="email" class="form-control" id="modal-cliente-email-input">
                            </div>
                            <div class="mb-2">
                                <label for="modal-cliente-telefono-input" class="form-label">Telefono</label>
                                <input type="text" class="form-control" id="modal-cliente-telefono-input">
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6><i class="bi bi-car-front"></i> Dettagli Servizio</h6>
                        <div class="bg-light p-3 rounded mb-3">
                            <div class="mb-3">
                                <label for="modal-tipo-auto-input" class="form-label">Tipo Auto</label>
                                <input type="text" class="form-control" id="modal-tipo-auto-input" 
                                       placeholder="Es: Fiat Panda Bianca">
                            </div>
                            <div class="mb-3">
                                <label for="modal-data-ora-input" class="form-label">Data e Ora Prenotazione</label>
                                <input type="text" class="form-control" id="modal-data-ora-input" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="modal-ora-consegna-input" class="form-label">Ora Consegna Richiesta</label>
                                <input type="time" class="form-control" id="modal-ora-consegna-input">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Durata Stimata</label>
                                <input type="text" class="form-control" id="modal-durata-input" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6><i class="bi bi-list-ul"></i> Servizi</h6>
                        <div class="bg-light p-3 rounded mb-3">
                            <div class="mb-3">
                                <label class="form-label">Servizi Disponibili</label>
                                <div class="row" id="modal-servizi-disponibili">
                                    {% for servizio in servizi_disponibili %}
                                    <div class="col-md-6 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input servizio-checkbox" type="checkbox" 
                                                   value="{{ servizio.id }}" id="servizio-{{ servizio.id }}"
                                                   data-nome="{{ servizio.titolo }}" 
                                                   data-prezzo="{{ servizio.prezzo }}"
                                                   onchange="updateServiziTotale()">
                                            <label class="form-check-label" for="servizio-{{ servizio.id }}">
                                                {{ servizio.titolo }} - €{{ servizio.prezzo }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <h6>Servizi Selezionati:</h6>
                                <div id="modal-servizi-selezionati" class="mb-2">
                                    <!-- Popolato dinamicamente -->
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <strong>Totale: €<span id="modal-totale">0.00</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6><i class="bi bi-chat-text"></i> Note</h6>
                        <div class="bg-light p-3 rounded">
                            <div class="mb-3">
                                <label for="modal-note-cliente-input" class="form-label">Note Cliente (originali)</label>
                                <textarea class="form-control" id="modal-note-cliente-input" rows="2" readonly></textarea>
                            </div>
                            <div class="mb-2">
                                <label for="modal-note-interne-input" class="form-label">Note Interne (modificabili)</label>
                                <textarea class="form-control" id="modal-note-interne-input" rows="2" 
                                          placeholder="Aggiungi note interne per l'ordine..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Annulla
                </button>
                <form method="post" id="checkin-form" style="display: inline;">
                    {% csrf_token %}
                    <!-- Hidden inputs per i dati modificabili -->
                    <input type="hidden" name="cliente_id" id="form-cliente-id">
                    <input type="hidden" name="tipo_cliente" id="form-tipo-cliente">
                    <input type="hidden" name="nome_cliente" id="form-nome-cliente">
                    <input type="hidden" name="cognome_cliente" id="form-cognome-cliente">
                    <input type="hidden" name="ragione_sociale" id="form-ragione-sociale">
                    <input type="hidden" name="email_cliente" id="form-email-cliente">
                    <input type="hidden" name="telefono_cliente" id="form-telefono-cliente">
                    <input type="hidden" name="servizi_ids" id="form-servizi-ids">
                    <input type="hidden" name="tipo_auto" id="form-tipo-auto">
                    <input type="hidden" name="ora_consegna_richiesta" id="form-ora-consegna">
                    <input type="hidden" name="note_interne" id="form-note-interne">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle-fill"></i> Conferma Check-in
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Dati delle prenotazioni per il modal
const prenotazioniData = {
    {% for prenotazione in prenotazioni %}
    {{ prenotazione.pk }}: {
        'cliente_nome': '{% if prenotazione.cliente.ragione_sociale %}{{ prenotazione.cliente.ragione_sociale }}{% else %}{{ prenotazione.cliente.nome }}{% if prenotazione.cliente.cognome %} {{ prenotazione.cliente.cognome }}{% endif %}{% endif %}',
        'cliente_email': '{{ prenotazione.cliente.email|default:"Non fornita" }}',
        'cliente_telefono': '{{ prenotazione.cliente.telefono|default:"Non fornito" }}',
        'tipo_auto': '{{ prenotazione.tipo_auto|default:"Non specificato" }}',
        'data_ora': '{{ prenotazione.slot.data|date:"d/m/Y" }} alle {{ prenotazione.slot.ora_inizio }}',
        'durata': '{{ prenotazione.durata_stimata_minuti }} minuti',
        'totale': '{{ prenotazione.totale_stimato|floatformat:2 }}',
        'nota_cliente': '{{ prenotazione.nota_cliente|default:"" }}',
        'codice': '{{ prenotazione.codice_prenotazione }}',
        'servizi': [
            {% for servizio in prenotazione.servizi.all %}
            {
                'nome': '{{ servizio.titolo }}',
                'prezzo': '{{ servizio.prezzo|floatformat:2 }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        'checkin_url': '{% url "prenotazioni:checkin-prenotazione" prenotazione.pk %}?from_checkin=true'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

// Variabile globale per memorizzare l'ID prenotazione corrente
let currentPrenotazioneId = null;

function showCheckinModal(prenotazioneId) {
    const data = prenotazioniData[prenotazioneId];
    if (!data) {
        alert('Errore: dati prenotazione non trovati');
        return;
    }
    
    currentPrenotazioneId = prenotazioneId;
    
    // Reset del form
    resetModalForm();
    
    // Popola i dati originali del cliente
    populateClienteData(data);
    
    // Popola i campi servizio
    document.getElementById('modal-data-ora-input').value = data.data_ora;
    document.getElementById('modal-durata-input').value = data.durata;
    document.getElementById('modal-tipo-auto-input').value = data.tipo_auto;
    
    // Calcola ora consegna suggerita
    calculateSuggestedDeliveryTime(data);
    
    // Popola i servizi prenotati
    populateServiziPrenotati(data.servizi);
    
    // Popola le note
    document.getElementById('modal-note-cliente-input').value = data.nota_cliente;
    document.getElementById('modal-note-interne-input').value = '';
    
    // Imposta l'action del form
    const form = document.getElementById('checkin-form');
    form.action = data.checkin_url;
    
    // Aggiungi event listener per il submit
    form.onsubmit = handleFormSubmit;
    
    // Mostra il modal
    const modal = new bootstrap.Modal(document.getElementById('checkinModal'));
    modal.show();
}

function resetModalForm() {
    // Reset selezione cliente
    document.getElementById('modal-cliente-select').value = '';
    document.getElementById('modal-tipo-cliente').value = 'privato';
    
    // Reset campi cliente
    document.getElementById('modal-cliente-nome-input').value = '';
    document.getElementById('modal-cliente-cognome-input').value = '';
    document.getElementById('modal-ragione-sociale-input').value = '';
    document.getElementById('modal-cliente-email-input').value = '';
    document.getElementById('modal-cliente-telefono-input').value = '';
    
    // Mostra campi privato, nascondi business
    document.getElementById('modal-campi-privato').style.display = 'block';
    document.getElementById('modal-campi-business').style.display = 'none';
    
    // Reset servizi
    document.querySelectorAll('.servizio-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateServiziTotale();
}

function populateClienteData(data) {
    // Popola i campi con i dati del cliente originale
    const clienteNomeCompleto = data.cliente_nome;
    
    // Tenta di trovare il cliente nella select
    const clienteSelect = document.getElementById('modal-cliente-select');
    let clienteTrovato = false;
    
    for (let option of clienteSelect.options) {
        if (option.textContent.trim() === clienteNomeCompleto.trim()) {
            clienteSelect.value = option.value;
            handleClienteChange();
            clienteTrovato = true;
            break;
        }
    }
    
    // Se non trovato, popola manualmente i campi
    if (!clienteTrovato) {
        const parti = clienteNomeCompleto.split(' ');
        if (parti.length === 1) {
            // Potrebbe essere ragione sociale
            document.getElementById('modal-tipo-cliente').value = 'business';
            handleTipoClienteChange();
            document.getElementById('modal-ragione-sociale-input').value = clienteNomeCompleto;
        } else {
            // Nome e cognome
            document.getElementById('modal-cliente-nome-input').value = parti[0];
            if (parti.length > 1) {
                document.getElementById('modal-cliente-cognome-input').value = parti.slice(1).join(' ');
            }
        }
        
        document.getElementById('modal-cliente-email-input').value = data.cliente_email !== 'Non fornita' ? data.cliente_email : '';
        document.getElementById('modal-cliente-telefono-input').value = data.cliente_telefono !== 'Non fornito' ? data.cliente_telefono : '';
    }
}

function calculateSuggestedDeliveryTime(data) {
    const oraPrenotazione = data.data_ora.match(/alle (\d{2}:\d{2})/);
    if (oraPrenotazione) {
        const [ore, minuti] = oraPrenotazione[1].split(':').map(Number);
        const durataMint = parseInt(data.durata);
        const oraConsegna = new Date();
        oraConsegna.setHours(ore, minuti + durataMint, 0, 0);
        const oraConsegnaStr = oraConsegna.toTimeString().substring(0, 5);
        document.getElementById('modal-ora-consegna-input').value = oraConsegnaStr;
    }
}

function populateServiziPrenotati(servizi) {
    // Seleziona i servizi prenotati
    servizi.forEach(servizio => {
        const checkbox = document.querySelector(`input[data-nome="${servizio.nome}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    updateServiziTotale();
}

function handleClienteChange() {
    const select = document.getElementById('modal-cliente-select');
    const selectedOption = select.options[select.selectedIndex];
    
    if (select.value) {
        // Cliente esistente selezionato
        const tipoCliente = selectedOption.dataset.tipo;
        document.getElementById('modal-tipo-cliente').value = tipoCliente;
        handleTipoClienteChange();
        
        // Popola i campi
        if (tipoCliente === 'business') {
            document.getElementById('modal-ragione-sociale-input').value = selectedOption.dataset.ragioneSociale;
        } else {
            document.getElementById('modal-cliente-nome-input').value = selectedOption.dataset.nome;
            document.getElementById('modal-cliente-cognome-input').value = selectedOption.dataset.cognome;
        }
        
        document.getElementById('modal-cliente-email-input').value = selectedOption.dataset.email;
        document.getElementById('modal-cliente-telefono-input').value = selectedOption.dataset.telefono;
    }
}

function handleTipoClienteChange() {
    const tipoCliente = document.getElementById('modal-tipo-cliente').value;
    const campiPrivato = document.getElementById('modal-campi-privato');
    const campiBusiness = document.getElementById('modal-campi-business');
    
    if (tipoCliente === 'business') {
        campiPrivato.style.display = 'none';
        campiBusiness.style.display = 'block';
    } else {
        campiPrivato.style.display = 'block';
        campiBusiness.style.display = 'none';
    }
}

function updateServiziTotale() {
    const checkboxes = document.querySelectorAll('.servizio-checkbox:checked');
    const serviziSelezionati = document.getElementById('modal-servizi-selezionati');
    const totaleSpan = document.getElementById('modal-totale');
    
    let totale = 0;
    serviziSelezionati.innerHTML = '';
    
    checkboxes.forEach(checkbox => {
        const prezzo = parseFloat(checkbox.dataset.prezzo);
        const nome = checkbox.dataset.nome;
        totale += prezzo;
        
        const badge = document.createElement('span');
        badge.className = 'badge bg-success me-2 mb-2';
        badge.textContent = `${nome} - €${prezzo.toFixed(2)}`;
        serviziSelezionati.appendChild(badge);
    });
    
    totaleSpan.textContent = totale.toFixed(2);
}

function handleFormSubmit() {
    // Popola i campi hidden con i dati del form
    const clienteSelect = document.getElementById('modal-cliente-select');
    document.getElementById('form-cliente-id').value = clienteSelect.value;
    document.getElementById('form-tipo-cliente').value = document.getElementById('modal-tipo-cliente').value;
    
    const tipoCliente = document.getElementById('modal-tipo-cliente').value;
    if (tipoCliente === 'business') {
        document.getElementById('form-ragione-sociale').value = document.getElementById('modal-ragione-sociale-input').value;
        document.getElementById('form-nome-cliente').value = '';
        document.getElementById('form-cognome-cliente').value = '';
    } else {
        document.getElementById('form-nome-cliente').value = document.getElementById('modal-cliente-nome-input').value;
        document.getElementById('form-cognome-cliente').value = document.getElementById('modal-cliente-cognome-input').value;
        document.getElementById('form-ragione-sociale').value = '';
    }
    
    document.getElementById('form-email-cliente').value = document.getElementById('modal-cliente-email-input').value;
    document.getElementById('form-telefono-cliente').value = document.getElementById('modal-cliente-telefono-input').value;
    
    // Servizi selezionati
    const serviziSelezionati = Array.from(document.querySelectorAll('.servizio-checkbox:checked'))
        .map(checkbox => checkbox.value);
    document.getElementById('form-servizi-ids').value = serviziSelezionati.join(',');
    
    // Altri campi
    document.getElementById('form-tipo-auto').value = document.getElementById('modal-tipo-auto-input').value;
    document.getElementById('form-ora-consegna').value = document.getElementById('modal-ora-consegna-input').value;
    document.getElementById('form-note-interne').value = document.getElementById('modal-note-interne-input').value;
    
    return true;
}

function submitFilter() {
    document.getElementById('filterForm').submit();
}

function clearFilters() {
    document.getElementById('data').value = '';
    document.getElementById('cliente').value = '';
    submitFilter();
}

// Auto-refresh ogni 5 minuti
setTimeout(() => {
    location.reload();
}, 300000);
</script>
{% endblock %}